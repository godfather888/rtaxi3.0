{"version":3,"sources":["../../../../../../../../../libs/database/src/lib/migration/1708414013082-sms-provider-module.ts"],"sourcesContent":["import { MigrationInterface, QueryRunner, Table, TableColumn } from 'typeorm';\nimport { existsSync, promises } from 'fs';\n\nexport enum SMSProviderType {\n  Firebase = 'Firebase',\n  Twilio = 'Twilio',\n  Plivo = 'Plivo',\n  Pahappa = 'Pahappa',\n  BroadNet = 'BroadNet',\n  Vonage = 'Vonage',\n  ClickSend = 'ClickSend',\n  Infobip = 'Infobip',\n  MessageBird = 'MessageBird',\n  VentisSMS = 'VentisSMS',\n}\n\nexport enum OperatorPermission {\n  Drivers_View = 'Drivers_View',\n  Drivers_Edit = 'Drivers_Edit',\n  Riders_View = 'Riders_View',\n  Riders_Edit = 'Riders_Edit',\n  Regions_View = 'Regions_View',\n  Regions_Edit = 'Regions_Edit',\n  Services_View = 'Services_View',\n  Services_Edit = 'Services_Edit',\n  Complaints_View = 'Complaints_View',\n  Complaints_Edit = 'Complaints_Edit',\n  Coupons_View = 'Coupons_View',\n  Coupons_Edit = 'Coupons_Edit',\n  Announcements_View = 'Announcements_View',\n  Announcements_Edit = 'Announcements_Edit',\n  Requests_View = 'Requests_View',\n  Fleets_View = 'Fleets_View',\n  Fleets_Edit = 'Fleets_Edit',\n  Gateways_View = 'Gateways_View',\n  Gateways_Edit = 'Gateways_Edit',\n  Users_View = 'Users_View',\n  Users_Edit = 'Users_Edit',\n  Cars_View = 'Cars_View',\n  Cars_Edit = 'Cars_Edit',\n  FleetWallet_View = 'FleetWallet_View',\n  FleetWallet_Edit = 'FleetWallet_Edit',\n  ProviderWallet_View = 'ProviderWallet_View',\n  ProviderWallet_Edit = 'ProviderWallet_Edit',\n  DriverWallet_View = 'DriverWallet_View',\n  DriverWallet_Edit = 'DriverWallet_Edit',\n  RiderWallet_View = 'RiderWallet_View',\n  RiderWallet_Edit = 'RiderWallet_Edit',\n  ReviewParameter_Edit = 'ReviewParameter_Edit',\n  Payouts_View = 'Payouts_View',\n  Payouts_Edit = 'Payouts_Edit',\n  GiftBatch_View = 'GiftBatch_View',\n  GiftBatch_Create = 'GiftBatch_Create',\n  GiftBatch_ViewCodes = 'GiftBatch_ViewCodes',\n  SMSProviders_View = 'SMSProviders_View',\n  SMSProviders_Edit = 'SMSProviders_Edit',\n}\n\nexport class SmsProviderModule1708414013082 implements MigrationInterface {\n  public async up(queryRunner: QueryRunner): Promise<void> {\n    try {\n      await queryRunner.createTable(\n        new Table({\n          name: 'sms_provider',\n          columns: [\n            new TableColumn({\n              name: 'id',\n              type: 'int',\n              isPrimary: true,\n              isGenerated: true,\n              generationStrategy: 'increment',\n            }),\n            new TableColumn({\n              name: 'name',\n              type: 'varchar',\n              isNullable: false,\n            }),\n            new TableColumn({\n              name: 'type',\n              type: 'enum',\n              enum: Object.values(SMSProviderType),\n              isNullable: false,\n            }),\n            new TableColumn({\n              name: 'isDefault',\n              type: 'boolean',\n              isNullable: false,\n              default: false,\n            }),\n            new TableColumn({\n              name: 'accountId',\n              type: 'varchar',\n              isNullable: true,\n            }),\n            new TableColumn({\n              name: 'authToken',\n              type: 'varchar',\n              isNullable: true,\n            }),\n            new TableColumn({\n              name: 'fromNumber',\n              type: 'varchar',\n              isNullable: true,\n            }),\n            new TableColumn({\n              name: 'verificationTemplate',\n              type: 'text',\n              isNullable: true,\n            }),\n            new TableColumn({\n              name: 'smsType',\n              type: 'varchar',\n              isNullable: true,\n            }),\n            new TableColumn({\n              name: 'createdAt',\n              type: 'datetime',\n              default: 'NOW()',\n            }),\n            new TableColumn({\n              name: 'deletedAt',\n              type: 'datetime',\n              isNullable: true,\n            }),\n          ],\n        }),\n        true,\n      );\n      const configAddress = `${process.cwd()}/config/config.${\n        process.env.NODE_ENV ?? 'production'\n      }.json`;\n      if (existsSync(configAddress)) {\n        const file = await promises.readFile(configAddress, {\n          encoding: 'utf-8',\n        });\n        const config: ICurrentConfiguration = JSON.parse(file as string);\n        if (\n          config.twilioAccountSid &&\n          config.twilioAuthToken &&\n          config.twilioFromNumber &&\n          config.twilioVerificationCodeSMSTemplate\n        ) {\n          await queryRunner.query(\n            `INSERT INTO sms_provider (name, type, isDefault, accountId, authToken, fromNumber, verificationTemplate, smsType) VALUES ('Twilio', 'Twilio', 1, '${config.twilioAccountSid}', '${config.twilioAuthToken}', '${config.twilioFromNumber}', '${config.twilioVerificationCodeSMSTemplate}', null)`,\n          );\n        }\n      }\n      await queryRunner.changeColumn(\n        'operator_role',\n        'permissions',\n        new TableColumn({\n          name: 'permissions',\n          type: 'set',\n          enum: Object.values(OperatorPermission),\n        }),\n      );\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  public async down(queryRunner: QueryRunner): Promise<void> {\n    try {\n      await queryRunner.dropTable('sms_provider');\n    } catch (error) {\n      console.error(error);\n    }\n  }\n}\n\ninterface ICurrentConfiguration {\n  purchaseCode?: string;\n  backendMapsAPIKey?: string;\n  adminPanelAPIKey?: string;\n  twilioAccountSid?: string;\n  twilioAuthToken?: string;\n  twilioFromNumber?: string;\n  twilioVerificationCodeSMSTemplate?: string;\n  firebaseProjectPrivateKey?: string;\n}\n"],"names":["SmsProviderModule1708414013082","SMSProviderType","OperatorPermission","up","queryRunner","createTable","Table","name","columns","TableColumn","type","isPrimary","isGenerated","generationStrategy","isNullable","enum","Object","values","default","configAddress","process","cwd","env","NODE_ENV","existsSync","file","promises","readFile","encoding","config","JSON","parse","twilioAccountSid","twilioAuthToken","twilioFromNumber","twilioVerificationCodeSMSTemplate","query","changeColumn","error","console","down","dropTable"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;;;;;;;;;;;;;;IA0DaA,8BAA8B;eAA9BA;;;yBA1DuD;oBAC/B;;UAEzBC;;;;;;;;;;;GAAAA,oBAAAA;;UAaAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GAAAA,uBAAAA;AA0CL,IAAA,AAAMF,iCAAN,MAAMA;IACX,MAAaG,GAAGC,WAAwB,EAAiB;QACvD,IAAI;YACF,MAAMA,YAAYC,WAAW,CAC3B,IAAIC,cAAK,CAAC;gBACRC,MAAM;gBACNC,SAAS;oBACP,IAAIC,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNC,WAAW;wBACXC,aAAa;wBACbC,oBAAoB;oBACtB;oBACA,IAAIJ,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNI,YAAY;oBACd;oBACA,IAAIL,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNK,MAAMC,OAAOC,MAAM,CAAChB;wBACpBa,YAAY;oBACd;oBACA,IAAIL,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNI,YAAY;wBACZI,SAAS;oBACX;oBACA,IAAIT,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNI,YAAY;oBACd;oBACA,IAAIL,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNI,YAAY;oBACd;oBACA,IAAIL,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNI,YAAY;oBACd;oBACA,IAAIL,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNI,YAAY;oBACd;oBACA,IAAIL,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNI,YAAY;oBACd;oBACA,IAAIL,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNQ,SAAS;oBACX;oBACA,IAAIT,oBAAW,CAAC;wBACdF,MAAM;wBACNG,MAAM;wBACNI,YAAY;oBACd;iBACD;YACH,IACA;YAEF,MAAMK,gBAAgB,CAAC,EAAEC,QAAQC,GAAG,GAAG,eAAe,EACpDD,QAAQE,GAAG,CAACC,QAAQ,IAAI,aACzB,KAAK,CAAC;YACP,IAAIC,IAAAA,cAAU,EAACL,gBAAgB;gBAC7B,MAAMM,OAAO,MAAMC,YAAQ,CAACC,QAAQ,CAACR,eAAe;oBAClDS,UAAU;gBACZ;gBACA,MAAMC,SAAgCC,KAAKC,KAAK,CAACN;gBACjD,IACEI,OAAOG,gBAAgB,IACvBH,OAAOI,eAAe,IACtBJ,OAAOK,gBAAgB,IACvBL,OAAOM,iCAAiC,EACxC;oBACA,MAAM/B,YAAYgC,KAAK,CACrB,CAAC,kJAAkJ,EAAEP,OAAOG,gBAAgB,CAAC,IAAI,EAAEH,OAAOI,eAAe,CAAC,IAAI,EAAEJ,OAAOK,gBAAgB,CAAC,IAAI,EAAEL,OAAOM,iCAAiC,CAAC,QAAQ,CAAC;gBAEpS;YACF;YACA,MAAM/B,YAAYiC,YAAY,CAC5B,iBACA,eACA,IAAI5B,oBAAW,CAAC;gBACdF,MAAM;gBACNG,MAAM;gBACNK,MAAMC,OAAOC,MAAM,CAACf;YACtB;QAEJ,EAAE,OAAOoC,OAAO;YACdC,QAAQD,KAAK,CAACA;QAChB;IACF;IAEA,MAAaE,KAAKpC,WAAwB,EAAiB;QACzD,IAAI;YACF,MAAMA,YAAYqC,SAAS,CAAC;QAC9B,EAAE,OAAOH,OAAO;YACdC,QAAQD,KAAK,CAACA;QAChB;IACF;AACF"}